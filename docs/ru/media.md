# Работа с файлами

Для хранения файлов необходимо задать сущности атрибут с типом `media`. Подробнее о типах атрибутов см. в разделе [Модель данных](data_model.md).
В поле этого атрибута хранится идентификатор записи сущности `media` из таблицы `core_media` основной БД.
Сам файл физически может храниться либо в файловой системе, либо в объектном хранилище [S3](https://aws.amazon.com/s3).
Настройки параметров хранения файлов находятся в файле [application.yml](/src/main/resources/application.yml) в блоке `scicms-core.media`.
Свойство `provider` принимает два значения: `local` и `s3` (по умолчанию используется переменная окружения `MEDIA_PROVIDER` или значение `local` в ее отсутствие).

Настройки хранения в файловой системе задаются в блоке `scicms-core.media.local`. Доступны следующие свойства:
- `base-path` - базовый путь сохранения (по умолчанию используется переменная окружения `MEDIA_LOCAL_PATH`);
- `create-directories` - флаг создания каталогов пути, если их еще не существует (по умолчанию выставлен в `true`).

Настройки хранения в объектном хранилище S3 задаются в блоке `scicms-core.media.s3`. Доступны следующие свойства:
- `endpoint` - адрес сервиса (по умолчанию используется переменная окружения `S3_ENDPOINT` или адрес `http://127.0.0.1:9000` в ее отсутствие);
- `access-key` - ключ доступа (по умолчанию используется переменная окружения `S3_ACCESS_KEY` или значение `minioadmin` в ее отсутствие);
- `secret-key` - секретный ключ (по умолчанию используется переменная окружения `S3_SECRET_KEY` или значение `minioadmin` в ее отсутствие);
- `default-bucket` - имя корзины для сохранения (по умолчанию используется переменная окружения `S3_DEFAULT_BUCKET` или значение `scicms` в ее отсутствие);

## Операции с файлами

### Выгрузка
Выгрузка файлов может быть выполнена либо через REST, либо через GraphQL API.

Первый способ предполагает отправку запроса `POST /api/media/upload`. В теле запроса типа `multipart/form-data` должны быть
следующие поля:
- `file` - выгружаемый файл;
- `label` - отображаемое имя файла (не обязательно);
- `description` - описание файла (не обязательно);
- `permission` - идентификатор разрешения (не обязательно).

Тело ответа имеет формат JSON и содержит данные о сохраненном файле:
```json
{
  "id": "6ee7e3fa-e5e3-4d81-92da-ddf123593a2a",
  "filename": "alice.png",
  "label": null,
  "description": null,
  "fileSize": 6984,
  "mimetype": "image/png",
  "checksum": "221f6b348cb4ba507f96d5790fa5ba9c",
  "createdAt": "2024-06-21T14:03:51.6940787+02:00"
}
```

Если необходимо отправить несколько файлов, используется запрос `POST /api/media/upload-multiple`. В теле запроса типа
`multipart/form-data` должны быть следующие поля:
- `files` - список выгружаемых файлов;
- `label` - список отображаемых имен файлов в том же порядке, что и файлы (не обязательно);
- `description` - список описаний файлов в том же порядке, что и файлы (не обязательно);
- `permissions` - список идентификаторов разрешений в том же порядке, что и файлы (не обязательно).

Ответ будет содержать JSON массив с данными о сохраненных файлах (структура аналогична предыдущему примеру).

Для выгрузки файла(ов) через GraphQL API служат методы `upload` и `uploadMultiple`.
В качестве единственного параметра эти методы принимают соответственно файл и список файлов (для представления файла в GraphQL служит специальный скалярный тип `Upload`).
Ответные сообщения аналогичны предыдущим двум методам REST.
Протокол GraphQL не позволяет передать при выгрузке файла какую либо дополнительную информацию и в данном случае она берется из атрибутов самих файлов.
Поэтому для выгрузки файлов рекомендуется использовать REST методы.

### Загрузка

Загрузка выполняется методом `GET /api/media/<media_id>/download`. Параметр `<media_id>` является идентификатором
записи `media`.

### Изменение информации о файле

Операция обновления выполняется стандартно, как и для любой другой сущности. Для этого необходимо выполнить GraphQL
запрос:
```
mutation {
  updateMedia(
    id: "6ee7e3fa-e5e3-4d81-92da-ddf123593a2a"
    deletingStrategy: NO_ACTION
    data: {
      label: "Alice"
    }
  ) {
    data {
      id
      filename
      label
    }
  }
}
```

### Удаление файла

Операция удаления также выполняется стандартно, как и для любой другой сущности:
```
mutation {	
  deleteMedia(
    id: "6ee7e3fa-e5e3-4d81-92da-ddf123593a2a"
    deletingStrategy: NO_ACTION
  ) {
    data {
      id
      filename
      label
    }
  }
}
```

Подробнее об операциях с сущностями см. в разделе [Модель данных](data_model.md).

Весь описанный API также используется в клиентском приложении [SciCMS Client](https://github.com/borisblack/scicms-client),
которое предоставляет удобный пользовательский интерфейс для манипуляции файлами, а также многие другие функции.
