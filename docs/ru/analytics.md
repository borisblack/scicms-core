# Инструменты аналитики

Доступ к аналитической информации осуществляется по REST API. Спецификация OpenAPI по всем методам доступна через
запущенное приложение на странице `/swagger-ui.html`.

## Источники данных

Создание источников данных описано в разделе [Модель данных](data_model.md). Здесь рассмотрим дополнительные операции в
контексте аналитических задач. В частности, для работы с источником данных требуется знать, какие таблицы он
содержит и какова структура этих таблиц.

### Получение информации о таблицах

Для получения детальной информации о таблицах, содержащихся в источнике данных, служит метод
`GET /api/datasource/<datasource_name>/tables`, где `<datasource_name>` - имя источника данных. В строке запроса также
могут передаваться следующие параметры (для построения строки запроса из JavaScript кода можно использовать библиотеку
[qs](https://github.com/ljharb/qs)):
- `schema` - название схемы БД (по умолчанию используется текущая схема пользователя, от имени которого открывается
  подключение);
- `q` - строка фильтра имени таблицы по частичному соответствию (не зависит от регистра);
- `pagination` - параметры постраничного разбиения (аналогичны используемым в
  [методах сущностей](data_model.md "Модель данных")).

Пример ответа:
```json
{
  "data": [
    {
      "name": "books",
      "columns": {
        "id": {
          "type": "string"
        },
        "rating": {
          "type": "int"
        }
      }
    }
  ],
  "meta": {
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 1,
      "pageCount": 1
    }
  }
}
```

Поле `type` выводится из реального типа данных столбца в БД и входит в подмножество допустимых
[типов атрибутов](data_model.md "Модель данных") для сущности. Может принимать следующие значения:
- `string` - строка фиксированной длины;
- `text` - строка неограниченной длины;
- `int` - целочисленный тип;
- `long` - длинный целочисленный тип;
- `float` - числовой тип с плавающей точкой;
- `double` - числовой тип с плавающей точкой двойной точности;
- `decimal` - тип для десятичного числа;
- `date` - тип для хранения даты;
- `time` - тип для хранения времени;
- `timestamp` - тип для хранения даты и времени;
- `bool` - логический тип.

## Датасеты

В SciCMS Core датасет соответствует таблице или произвольному SQL запросу в базе данных. Создание/изменение/удаление
датасета ничем не отличается от аналогичной GraphQL операции с любой другой сущностью.

### Создание датасета

```
mutation {
  createDataset(
    data: {
      name: "orders",
      datasource: "d17966c3-ea6c-4394-aef5-c9ac5c93d5bd",
      tableName: "orders",
      cacheTtl: 10
      spec: {
        columns: {
          o_orderkey: {
            hidden: true
          },
          o_total_price: {
            hidden: true
          },
          o_comment: {
            hidden: true
          },
          orders_cnt: {
            custom: true,
            aggregate: "count",
            source: "o_orderkey"
          }
        }
      }
    }
  ) {
    data {
      name
      datasource {
        data {
          id
          name
        }
      }
      tableName
    }
  }
}
```

В поле `name` передается имя датасета (латиницей без пробелов), оно используется при выполнении запросов (см. ниже).
Поле `datasource` содержит идентификатор источника данных.

Обязательно должен быть передан один из двух параметров: `tableName` (имя таблицы) или `query` (произвольный SQL запрос).
Если переданы оба, то при обращении к датасету приоритет имеет параметр `tableName`.

Также, как и сущность, датасет имеет необязательный параметр `cacheTtl` - время жизни кэша в минутах. Если он не задан,
то принимается значение по умолчанию, равное 5 минут (параметр `scicms-core.data.dataset-query-result-entry-ttl-minutes`
в файле [application.yml](/src/main/resources/application.yml)). Если значение кэша меньше или равно 0, то записи в
датасете не кэшируются. Кэш сбрасывается при каждом перезапуске приложения.

Поле `spec` содержит описание столбцов во вложенном поле `columns`. Имя атрибута выступает в роли ключа. Значение может
включать следующие свойства:
- `custom` - источник данных может содержать так называемые кастомные (виртуальные) столбцы, которые используются при
  построении аналитических запросов (см. ниже); для кастомных столбцов данное свойство выставляется в значение `true`;
- `hidden` - некоторые столбцы могут исключаться из запроса. В этом случае данное свойство выставляется в значение `true`;
- `aggregate` - имя агрегатной функции, может принимать значения `count`, `countd`, `sum`, `avg`, `min`, `max`
  (см. ниже); применимо только к кастомным столбцам;
- `formula` - произвольное SQL выражение для выполнения более сложных агрегаций (см. ниже). Применимо только к кастомным
  столбцам; если заданы свойства `aggregate` и `formula`, приоритет отдается первому;
- `source` - имя реального столбца в случае, если столбец кастомный и не задано свойство `formula`;
- `alias` - псевдоним столбца для отображения в пользовательском интерфейсе, используется в клиентском приложении
  [SciCMS Client](https://github.com/borisblack/scicms-client);
- `format` - формат значения столбца для отображения в пользовательском интерфейсе, используется в клиентском приложении
  [SciCMS Client](https://github.com/borisblack/scicms-client); может принимать значения `int`, `float`, `date`, `time`,
  `datetime`;
- `colWidth` - ширина столбца для отображения в пользовательском интерфейсе, используется в клиентском приложении
  [SciCMS Client](https://github.com/borisblack/scicms-client).

Изменение датасета выполняется операцией `updateDataset` с аналогичными параметрами GraphQL запроса.

### Получение данных

Для запроса данных из датасета служит метод `GET /api/dataset/<dataset_name>`, где `<dataset_name>` - имя датасета. В
строке запроса также могут передаваться следующие параметры (для построения строки запроса из JavaScript кода можно
использовать библиотеку [qs](https://github.com/ljharb/qs)):
- `fields` - список полей (см. ниже);
- `filters` - блок фильтров (структура аналогична используемой при [фильтрации сущностей](data_model.md "Модель данных"),
  но операторы должны предваряться символом `$`), см. пример ниже;
- `sort` - список полей сортировки (аналогичен используемому в [методах сущностей](data_model.md "Модель данных")).
- `pagination` - параметры постраничного разбиения (аналогичны используемым в
  [методах сущностей](data_model.md "Модель данных")).

Каждое поле в списке `fields` имеет структуру, включающую подмножество свойств столбца датасета: `name`, `type`,
`custom`, `source`, `aggregate`, `formula`.

Ниже приведен пример запроса к базе данных [TPC-H](https://www.tpc.org/tpch), предназначенной для
тестирования производительности SQL запросов:
```json
{
  "fields": [
    {
      "name": "o_custkey"
    },
    {
      "name": "o_orderstatus"
    },
    {
      "name": "orders_cnt",
      "custom": true,
      "aggregate": "count",
      "source": "o_orderkey"
    }
  ],
  "filters": {
    "orders_cnt": {
      "$gte": 10
    }
  }
}
```

Данный простой запрос выполняет подсчет количества заказов в разрезе клиента и статуса заказа, отбирая только те записи,
где вычисленное значение больше или равно 10. Фильтровать можно как по обычным полям, так и по агрегатам. Если поле
`fields` не передается в запросе, то используется конфигурация столбцов из спецификации датасета. При этом, если столбец
имеет флаг `hidden`, то он не участвует в запросе. Поэтому тот же результат можно получить, если не передавать `fields`
и использовать спецификацию, описанную выше для метода `createDataset`.

Вместо `aggregate` и `source` можно передать поле `formula`, которое может содержать произвольное выражение для
агрегации, например, `COUNT(DISTINCT([id]))` (то же самое, что агрегат `countd`). Имена столбцов таблицы в таких
выражениях нужно заключать в квадратные скобки.

Пример ответа:
```json
{
  "data": [
    {
      "orders_cnt": 10,
      "o_orderstatus": "F",
      "o_custkey": 712
    },
    {
      "orders_cnt": 10,
      "o_orderstatus": "F",
      "o_custkey": 433
    },
    {
      "orders_cnt": 10,
      "o_orderstatus": "O",
      "o_custkey": 715
    }
  ],
  "query": "SELECT COUNT(t0.o_orderkey) AS orders_cnt,t0.o_orderstatus,t0.o_custkey FROM orders t0 GROUP BY t0.o_orderstatus,t0.o_custkey HAVING (COUNT(t0.o_orderkey) > :countt0o_orderkey_0_gte) OFFSET 0 ROWS FETCH NEXT 20 ROWS ONLY",
  "params": {
    "countt0id_0_gte": 10
  },
  "timeMs": 1,
  "cacheHit": true,
  "meta": {
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 132,
      "pageCount": 7,
      "timeMs": 2,
      "cacheHit": true
    }
  }
}
```

Блок `data` содержит найденные записи, блок `meta` - информацию о пагинации. Кроме них, в ответе присутствуют такие
поля как `query` (текст реального запроса в БД), `params` (параметры запроса), `cacheHit` (флаг попадания в кэш) и
`timeMs` (время выполнения запроса в миллисекундах). Эти поля служат для анализа производительности запросов. Если
датасет кэшируемый, но размер данных превышает параметр конфигурации приложения
`scicms-core.data.max-cached-records-size` (по умолчанию - 200), то данные не будут кэшироваться.

На базе описанного инструментария в клиентском приложении [SciCMS Client](https://github.com/borisblack/scicms-client)
реализован модуль бизнес-анализа, который предоставляет удобный пользовательский интерфейс для управления источниками
данных и датасетами, построения панелей визуализации, а также многие другие функции.
